<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI Ecommerce Pricing Engine</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  /* ─── Reset & Base ─── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', system-ui, sans-serif;
    background: #0f1623;
    color: #d1d9e6;
    min-height: 100vh;
    padding: 24px;
  }
  a { color: #7c9ff5; text-decoration: none; }

  /* ─── Layout ─── */
  .wrapper { max-width: 1200px; margin: 0 auto; }

  /* ─── Header ─── */
  .header {
    text-align: center;
    padding: 28px 0 18px;
  }
  .header h1 {
    font-size: 1.9rem;
    background: linear-gradient(135deg, #7c9ff5, #a78bfa);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 6px;
  }
  .header p { color: #6b7a8f; font-size: 0.88rem; }

  /* ─── Cards ─── */
  .card {
    background: #1a2332;
    border: 1px solid #243044;
    border-radius: 12px;
    padding: 22px 24px;
    margin-bottom: 20px;
  }
  .card h2 {
    font-size: 1rem;
    color: #a0b4cc;
    margin-bottom: 16px;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    font-weight: 600;
  }

  /* ─── Two-column grid ─── */
  .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  @media (max-width: 700px) { .grid-2 { grid-template-columns: 1fr; } }

  /* ─── Form ─── */
  .form-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 14px; }
  .form-group label {
    display: block;
    font-size: 0.78rem;
    color: #6b7a8f;
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .form-group input, .form-group select {
    width: 100%;
    background: #121c2a;
    border: 1px solid #2a3a52;
    border-radius: 7px;
    color: #d1d9e6;
    padding: 9px 12px;
    font-size: 0.9rem;
    transition: border-color .2s;
  }
  .form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: #7c9ff5;
  }
  .form-group select option { background: #1a2332; }

  /* ─── Slider ─── */
  .slider-row { display: flex; align-items: center; gap: 12px; }
  .slider-row input[type=range] {
    flex: 1;
    -webkit-appearance: none;
    background: #2a3a52;
    height: 5px;
    border-radius: 3px;
    border: none;
    outline: none;
  }
  .slider-row input[type=range]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 16px; height: 16px;
    background: #7c9ff5;
    border-radius: 50%;
    cursor: pointer;
  }
  .slider-label { font-size: 0.78rem; color: #6b7a8f; min-width: 38px; text-align: right; }

  /* ─── Button ─── */
  .btn {
    display: inline-flex; align-items: center; justify-content: center;
    background: linear-gradient(135deg, #4f7cf5, #7c5ff5);
    color: #fff; border: none; border-radius: 8px;
    padding: 11px 28px; font-size: 0.92rem; font-weight: 600;
    cursor: pointer; transition: opacity .2s, transform .1s;
    margin-top: 8px;
  }
  .btn:hover { opacity: .88; }
  .btn:active { transform: scale(.97); }
  .btn .spinner {
    display: none; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,.3);
    border-top-color: #fff; border-radius: 50%;
    animation: spin .5s linear infinite;
    margin-right: 8px;
  }
  .btn.loading .spinner { display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ─── Result Card ─── */
  .result-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
  .result-box {
    background: #121c2a; border-radius: 9px; padding: 16px; text-align: center;
    border: 1px solid #2a3a52;
  }
  .result-box .val { font-size: 1.6rem; font-weight: 700; color: #7c9ff5; }
  .result-box .lbl { font-size: 0.72rem; color: #6b7a8f; text-transform: uppercase; margin-top: 3px; letter-spacing: 0.5px; }
  .result-box.green .val { color: #4ade80; }
  .result-box.amber .val { color: #fbbf24; }

  /* ─── Chart ─── */
  .chart-wrap { position: relative; height: 280px; margin-top: 6px; }

  /* ─── Stats Table ─── */
  .stats-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
  .stats-table th {
    text-align: left; color: #6b7a8f; font-weight: 600;
    border-bottom: 1px solid #2a3a52; padding: 8px 6px;
    text-transform: uppercase; letter-spacing: 0.4px; font-size: 0.72rem;
  }
  .stats-table td { padding: 9px 6px; border-bottom: 1px solid #1e2d3f; }
  .stats-table tr:last-child td { border-bottom: none; }
  .badge {
    display: inline-block; background: #1a2d45; color: #7c9ff5;
    border-radius: 5px; padding: 2px 8px; font-size: 0.75rem;
  }

  /* ─── Metrics Panel ─── */
  .metrics-row { display: flex; gap: 16px; flex-wrap: wrap; }
  .metric-chip {
    background: #121c2a; border: 1px solid #2a3a52; border-radius: 8px;
    padding: 10px 16px; flex: 1; min-width: 130px;
  }
  .metric-chip .mc-val { font-size: 1.2rem; font-weight: 700; color: #a78bfa; }
  .metric-chip .mc-lbl { font-size: 0.7rem; color: #6b7a8f; margin-top: 2px; }

  /* ─── Hidden placeholder ─── */
  .placeholder { color: #3a4f66; text-align: center; padding: 60px 0; font-size: 0.85rem; }
  .placeholder.hidden { display: none; }
  .results-section { display: none; }
  .results-section.visible { display: block; }
</style>
</head>
<body>
<div class="wrapper">

  <!-- HEADER -->
  <div class="header">
    <h1>⚡ AI Ecommerce Pricing Engine</h1>
    <p>Dynamically optimise product prices to maximise margins &amp; conversions using ML models</p>
  </div>

  <!-- INPUT FORM -->
  <div class="card">
    <h2>Product Parameters</h2>
    <div class="form-grid">
      <div class="form-group">
        <label>Category</label>
        <select id="category">
          {% for c in categories %}
          <option value="{{ c }}">{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label>Competitor Price ($)</label>
        <input type="number" id="competitor" value="120" step="1" min="1"/>
      </div>
      <div class="form-group">
        <label>Demand Score (0–100)</label>
        <input type="number" id="demand" value="65" step="1" min="0" max="100"/>
      </div>
      <div class="form-group">
        <label>Seasonality (0.7–1.4)</label>
        <input type="number" id="season" value="1.1" step="0.1" min="0.7" max="1.4"/>
      </div>
      <div class="form-group">
        <label>Product Rating (1–5)</label>
        <input type="number" id="rating" value="4.2" step="0.1" min="1" max="5"/>
      </div>
      <div class="form-group">
        <label>Stock Level</label>
        <input type="number" id="stock" value="45" step="1" min="1"/>
      </div>
    </div>

    <!-- Alpha slider -->
    <div style="margin-top:18px;">
      <div style="display:flex; justify-content:space-between; margin-bottom:6px;">
        <span style="font-size:.78rem; color:#6b7a8f; text-transform:uppercase; letter-spacing:.5px;">Strategy Weight</span>
        <span style="font-size:.72rem; color:#6b7a8f;">← Conversions &nbsp;&nbsp; Margin →</span>
      </div>
      <div class="slider-row">
        <span style="font-size:.72rem; color:#6b7a8f; min-width:56px;">Conv.</span>
        <input type="range" id="alpha" value="60" min="0" max="100"/>
        <span style="font-size:.72rem; color:#6b7a8f; min-width:56px; text-align:left;">Margin</span>
      </div>
    </div>

    <button class="btn" id="optimizeBtn" onclick="runOptimize()">
      <span class="spinner"></span> Optimize Price
    </button>
  </div>

  <!-- RESULTS (hidden until first run) -->
  <div class="results-section" id="resultsSection">

    <!-- KPI boxes -->
    <div class="card">
      <h2>Recommended Pricing</h2>
      <div class="result-grid">
        <div class="result-box">
          <div class="val" id="optimalPrice">—</div>
          <div class="lbl">Optimal Price</div>
        </div>
        <div class="result-box green">
          <div class="val" id="expRevenue">—</div>
          <div class="lbl">Expected Revenue</div>
        </div>
        <div class="result-box amber">
          <div class="val" id="convProb">—</div>
          <div class="lbl">Conversion Prob.</div>
        </div>
      </div>
    </div>

    <!-- Chart -->
    <div class="card">
      <h2>Price Sweep Analysis</h2>
      <div class="chart-wrap">
        <canvas id="sweepChart"></canvas>
      </div>
    </div>
  </div>

  <!-- STATS + METRICS row -->
  <div class="grid-2">
    <div class="card">
      <h2>Category Statistics</h2>
      <table class="stats-table">
        <thead>
          <tr>
            <th>Category</th>
            <th>Avg Price</th>
            <th>Avg Revenue</th>
            <th>Conv. Rate</th>
          </tr>
        </thead>
        <tbody id="statsBody">
          {% for cat, s in stats.items() %}
          <tr>
            <td><span class="badge">{{ cat }}</span></td>
            <td>${{ s.avg_price }}</td>
            <td>${{ s.avg_revenue }}</td>
            <td>{{ s.conversion_rate }}%</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="card">
      <h2>Model Performance</h2>
      <div class="metrics-row">
        <div class="metric-chip">
          <div class="mc-val">${{ metrics.revenue_rmse }}</div>
          <div class="mc-lbl">Revenue RMSE</div>
        </div>
        <div class="metric-chip">
          <div class="mc-val">{{ metrics.revenue_r2 }}</div>
          <div class="mc-lbl">Revenue R²</div>
        </div>
        <div class="metric-chip">
          <div class="mc-val">{{ (metrics.conv_accuracy * 100)|round(1) }}%</div>
          <div class="mc-lbl">Conversion Acc.</div>
        </div>
      </div>
      <p style="margin-top:18px; font-size:.78rem; color:#4a5f75; line-height:1.5;">
        <strong style="color:#6b7a8f;">Ridge Regression</strong> predicts expected revenue for each candidate price.
        <strong style="color:#6b7a8f;">Logistic Regression</strong> estimates the probability the customer will convert.
        The engine sweeps 200 candidate prices and picks the one maximising the weighted score.
      </p>
    </div>
  </div>

</div><!-- /wrapper -->

<!-- ─── JavaScript ─── -->
<script>
let chart = null;

async function runOptimize() {
  const btn = document.getElementById("optimizeBtn");
  btn.classList.add("loading");
  btn.disabled = true;

  const payload = {
    category:   document.getElementById("category").value,
    competitor: document.getElementById("competitor").value,
    demand:     document.getElementById("demand").value,
    season:     document.getElementById("season").value,
    rating:     document.getElementById("rating").value,
    stock:      document.getElementById("stock").value,
    alpha:      (parseInt(document.getElementById("alpha").value) / 100).toFixed(2),
  };

  try {
    const res  = await fetch("/optimize", { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload) });
    const data = await res.json();
    renderResults(data);
  } catch(e) {
    alert("Error: " + e.message);
  }
  btn.classList.remove("loading");
  btn.disabled = false;
}

function renderResults(data) {
  // Show section
  document.getElementById("resultsSection").classList.add("visible");

  // KPIs
  document.getElementById("optimalPrice").textContent  = "$" + data.optimal_price;
  document.getElementById("expRevenue").textContent    = "$" + data.expected_revenue;
  document.getElementById("convProb").textContent      = data.conversion_prob + "%";

  // Chart
  const sweep = data.sweep;
  const ctx   = document.getElementById("sweepChart").getContext("2d");

  if (chart) chart.destroy();

  // Mark optimal price with a vertical line via a plugin
  const optIdx = sweep.prices.indexOf(data.optimal_price);

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: sweep.prices,
      datasets: [
        {
          label: "Expected Revenue ($)",
          data: sweep.revenues,
          borderColor: "#7c9ff5",
          backgroundColor: "rgba(124,159,245,0.08)",
          borderWidth: 2,
          pointRadius: 0,
          fill: true,
          tension: 0.3,
          yAxisID: "yRev",
        },
        {
          label: "Conversion Prob. (%)",
          data: sweep.conversions,
          borderColor: "#4ade80",
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.3,
          yAxisID: "yConv",
        },
        {
          label: "Combined Score",
          data: sweep.scores,
          borderColor: "#a78bfa",
          borderWidth: 2.5,
          borderDash: [6,3],
          pointRadius: 0,
          tension: 0.3,
          yAxisID: "yScore",
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode:"index", intersect:false },
      plugins: {
        legend: { labels: { color:"#a0b4cc", font:{size:11} } },
        tooltip: { backgroundColor:"#1a2332", titleColor:"#d1d9e6", bodyColor:"#a0b4cc", borderColor:"#2a3a52", borderWidth:1 }
      },
      scales: {
        x: {
          ticks: { color:"#6b7a8f", maxTicksLimit:10, font:{size:10} },
          grid: { color:"#1e2d3f" },
          title: { display:true, text:"Price ($)", color:"#6b7a8f", font:{size:11} }
        },
        yRev: {
          position:"left",
          ticks: { color:"#7c9ff5", font:{size:10} },
          grid: { color:"#1e2d3f" },
          title: { display:true, text:"Revenue ($)", color:"#7c9ff5", font:{size:10} }
        },
        yConv: {
          position:"right",
          ticks: { color:"#4ade80", font:{size:10} },
          grid: { display:false },
          title: { display:true, text:"Conversion %", color:"#4ade80", font:{size:10} }
        },
        yScore: {
          position:"right",
          ticks: { color:"#a78bfa", font:{size:10} },
          grid: { display:false },
          title: { display:false }
        }
      }
    },
    plugins: [
      // vertical line at optimal price
      {
        id: "optimalLine",
        afterDraw(chart) {
          const xScale = chart.scales.x;
          const opt = data.optimal_price;
          const idx = sweep.prices.indexOf(opt);
          if (idx === -1) return;
          const xPos = xScale.getPixelForValue(idx);
          const ctx  = chart.ctx;
          ctx.save();
          ctx.strokeStyle = "#fbbf24";
          ctx.lineWidth   = 2;
          ctx.setLineDash([5,4]);
          ctx.beginPath();
          ctx.moveTo(xPos, chart.chartArea.top);
          ctx.lineTo(xPos, chart.chartArea.bottom);
          ctx.stroke();
          // label
          ctx.fillStyle = "#fbbf24";
          ctx.font      = "bold 11px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("Optimal: $" + opt, xPos, chart.chartArea.top - 6);
          ctx.restore();
        }
      }
    ]
  });
}
</script>
</body>
</html>
